<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <script src="js/jquery.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet"/>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/cookie.js"></script>
    <style>
        .show-border {
            border: solid 1px blueviolet;
        }

        .input-text {
            margin-bottom: 2px;
        }

        .div-button {
            margin: 5px 0px;
        }
    </style>
</head>
<body>
<script>
    $(document).ready(function () {
        if ($.cookie("username") == null) {
            location.href = "./login.html";
        } else {
            $("#bj").html($.cookie("username"));
        }
        $(document).on("click", ".urltitle", function () {
            var url = $(this).attr("href");
            var title = $(this).html();
            var id = $(this).attr("id");
            var ajaxurl = 'http://127.0.0.1:8000/user/read?userid=' + $.cookie("userid") + '&url=' + encodeURIComponent(url) + '&title=' + title;
            $.ajax({
                type: "GET",
                url: ajaxurl,
                dataType: "jsonp",
                jsonp: "callback",
                success: function (data) {
                    console.log(data["data"]);
                    $("#" + id).css("color", "red");
                },
                error: function () {
                    alert("加载失败");
                }
            })
        })
        $(document).on("click", ".btndel", function () {
            var b = confirm("是否删除当前所选订阅信息");
            if (!b) {
                return;
            }
            var vid = $(this).attr("id");
            var sid = vid.substr(4, vid.length);
            var userid = $.cookie("userid");
            var kw = $("#del_keyword_" + sid).html();
            var tkw = $("#del_titlekeyword_" + sid).html();
            if (kw == "无") {
                kw = "";
            }
            if (tkw == "无") {
                tkw = "";
            }
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:8000/user/delsub?userid=" + userid + "&url=" + encodeURIComponent($("#del_url_" + sid).html()) + "&keyword=" + kw + "&titlekeyword=" + tkw + "&token=" + encodeURIComponent($("#del_token_" + sid).html()),
                dataType: "jsonp",
                jsonp: "callback",
                success: function (data) {
                    $("#check_sub").trigger("click");
                    alert("删除成功");
                },
                error: function () {
                    alert("加载失败");
                }
            });
        });
        $("#reset").click(function () {
            $("#url").val("");
            $("#titlekey").val("");
            $("#token").val("");
            $("#keyword").val("");
        });
        $("#submit").click(function () {
            var userid = $.cookie("userid");
            if ($("#url").val() == "" || $("#token").val() == "") {
                alert("请输入必要的输入信息！");
                return;
            }
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:8000/user/sub?userid=" + userid + "&url=" + encodeURIComponent($("#url").val()) + "&keyword=" + $("#keyword").val() + "&titlekeyword=" + $("#titlekey").val() + "&token=" + encodeURIComponent($("#token").val()),
                dataType: "jsonp",
                jsonp: "callback",
                success: function (data) {
                    alert(data["data"]);
                },
                error: function () {
                    alert("加载失败");
                }
            });


        });
        $("#check_sub").click(function () {
            var userid = $.cookie("userid");
            var username = $.cookie("username");
            var url = "//127.0.0.1:8000/user/getsub?userid=" + userid;
            $.ajax({
                type: "GET",
                url: url,
                dataType: "jsonp",
                jsonp: "callback",
                success: function (data) {
                    if (data["errno"] == 0) {
                        if (data["data"] == null || data["data"].length == 0) {
                            var html = '<div class="col-md-12"><h2 style="text-align: center;padding-top: 20px;">用户没有订阅消息</h2>';
                            $("#contain").html(html);
                            return;
                        }
                        var html = '<div class="col-md-12"><h2 style="text-align: center;padding-top: 20px;">用户订阅消息</h2><table class="table table-striped"><thead><tr><th style="text-align: center;">用户名</th><th style="text-align: center;">用户订阅URL</th><th style="text-align: center;">订阅关键字</th><th style="text-align: center;">订阅搜索标题关键字</th><th style="text-align: center;">搜索网页令牌</th><th style="text-align: center;">选项</th></tr></thead><tbody>';
                        $.each(data["data"], function (i, d) {
                            html += "<tr id='tr_'" + i + ">";
                            html += '<td style="text-align: center;">' + username + '</td>';
                            html += '<td style="text-align: center;" id="del_url_' + i + '">' + d["url"] + '</td>';
                            if (d["keyword"] == "") {
                                html += '<td style="text-align: center;" id="del_keyword_' + i + '">无</td>';
                            } else {
                                html += '<td style="text-align: center;" id="del_keyword_' + i + '">';
                                html += d["keyword"];
                                html += '</td>';
                            }
                            if (d["titlekeyword"].length == 0) {
                                html += '<td style="text-align: center;" id="del_titlekeyword_' + i + '">无</td>';
                            } else {
                                html += '<td style="text-align: center;" id="del_titlekeyword_' + i + '">';
                                var tkey = "";
                                $.each(d['titlekeyword'], function (i, j) {
                                    if (i != 0) {
                                        tkey += ',';
                                    }
                                    tkey += j;
                                });
                                html += tkey;
                                html += '</td>';
                            }
                            html += '<td style="text-align: center;" id="del_token_' + i + '">' + d["token"] + '</td>';
                            html += '<td style="text-align: center;"><button class="btn btndel" id="btn_' + i + '" class="btn btn-block">删除</button></td>';
                            html += '</tr>';
                        })
                        html += '</tbody></table></div>'
                        $("#contain").html(html);
                    } else {
                        var html = '<div class="col-md-12"><h2 style="text-align: center;padding-top: 20px;">用户没有订阅消息</h2>';
                        $("#contain").html(html);
                        return;
                    }
                },
                error: function (errmsg) {
                    alert("加载失败");
                }
            })
        });
        $("#get_readed").click(function () {
            var userid = $.cookie("userid");
            var url = "//127.0.0.1:8000/user/readed?userid=" + userid;
            $.ajax({
                type: "GET",
                url: url,
                dataType: "jsonp",
                jsonp: "callback",
                success: function (data) {
                    if (data["data"] == null || data["data"]["submsg"] == null || data["data"]["submsg"].length == 0) {
                        var html = '<div class="col-md-12"><h2 style="text-align: center;padding-top: 20px;">用户没有已读消息</h2>';
                        $("#contain").html(html);
                        return;
                    }
                    var html = '<div class="col-md-12"><h2 style="text-align: center;padding-top: 20px;">用户已读消息如下</h2><table class="table table-striped"><tbody>';
                    $.each(data["data"]["submsg"], function (i, d) {
                        if (i % 3 == 0) {
                            html += "<tr>";
                        }
                        html += '<td style="text-align: center" width="33.3%"><a href="' + d["url"] + '" target="_blank">' + d["title"] + '</a></td>';
                        if (i % 3 == 2) {
                            html += "</tr>";
                        }
                    })
                    html += "</tbody></table></div>";
                    $("#contain").html(html);
                },
                error: function () {
                    alert("加载失败");
                }
            })
        });
        $("#get_noread").click(function () {
            var userid = $.cookie("userid");
            var url = "//127.0.0.1:8000/user/noread?userid=" + userid;
            $.ajax({
                type: "GET",
                url: url,
                dataType: "jsonp",
                jsonp: "callback",
                success: function (data) {
                    if (data["data"] == null || data["data"]["submsg"] == null || data["data"]["submsg"].length == 0) {
                        var html = '<div class="col-md-12"><h2 style="text-align: center;padding-top: 20px;">用户没有未读消息</h2>';
                        $("#contain").html(html);
                        return;
                    }
                    var html = '<div class="col-md-12"><h2 style="text-align: center;padding-top: 20px;">用户未读消息如下</h2><table class="table table-striped"><tbody>';
                    $.each(data["data"]["submsg"], function (i, d) {
                        if (i % 3 == 0) {
                            html += "<tr>";
                        }
                        html += '<td style="text-align: center;" width="33.3%"><a class="urltitle" id="urltitle_' + i + '" href="' + d["url"] + '" target="_blank">' + d["title"] + '</a></td>';
                        if (i % 3 == 2) {
                            html += "</tr>";
                        }
                    })
                    html += "</tbody></table></div>";
                    $("#contain").html(html);
                },
                error: function () {
                    alert("加载失败");
                }
            })
        });
    })
</script>
<div id="ck" hidden></div>
<div class="container" style="padding-top:20px;">
    <div class="row" style="background-color:#afbfcf;">
        <div class="col-md-12">
            <div class="text-center">
                <h1><span id="bj"></span>，欢迎来到专向订阅爬虫</h1>
            </div>
        </div>
    </div>
    <div class="row" style="background-color:lightgoldenrodyellow;">
        <div class="col-md-6" style="border-right:1px solid black;">
            <div class="row">
                <form role="form" style="width: 96%;margin-left: 2%;">
                    <fieldset>
                        <legend style="text-align: center;">用户订阅</legend>
                        <div class="row">
                            <div class="col-md-12">
                                <input class="input-text form-control" id="url" type="text" name="starturl"
                                       placeholder="初始URL，以http开头"/>
                                <input class="input-text form-control" id="keyword" type="text" name="keyword"
                                       placeholder="关键字，只支持一个关键字，可以为空"/>
                                <input class="input-text form-control" id="titlekey" type="text" name="titlekeyword"
                                       placeholder="标题关键字，多关键字用英文逗号隔开，可以为空"/>
                                <input class="input-text form-control" id="token" type="text" name="token"
                                       placeholder="网页token，爬虫搜索url限定域"/>
                            </div>
                        </div>
                        <div class="row div-button" style="width: 100%;margin-top: 5px;">
                            <div class="col-md-2"></div>
                            <input class="col-md-3 btn btn-primary" id="submit" type="button" value="提交"/>
                            <div class="col-md-2"></div>
                            <input class="col-md-3 btn btn-primary" id="reset" type="button" value="重置"/>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <fieldset>
                <legend style="text-align: center">用户操作</legend>
                <div class="row">
                    <div class="col-md-12">
                        <button id="check_sub" class="div-button btn btn-block" type="button">查看订阅消息</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <button id="get_noread" class="div-button btn btn-block" type="button">获取未读消息</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <button id="get_readed" class="div-button btn btn-block" type="button">获取已读消息</button>
                    </div>
                </div>
            </fieldset>
        </div>
    </div>
    <div class="row" id="contain" style="background-color:azure;">

    </div>
    <div class="row" style="background-color:#afbfcf;">
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-12">
                    <div style="text-align: center">
                        <h1>dh爱你的我&copy;版权所有</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>